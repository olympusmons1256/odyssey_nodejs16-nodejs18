REST API
==========================================

NestJS REST API for Odyssey

* Runs as a firebase function under the `/api` endpoint
* Provides swagger server or openapi.json (dynamically generated at runtime)
* Only Oauth2 client credentials grant supported currently.


## Run

### Build

This application is built as part of the `functions` build.

`npm run build`

### Test

`npm run restapi`

The API will be

### Test (emulator)

1. Start the emulator using instructions in ../../README.md
2. API will be reachable on `http://localhost:5005/ngp-odyssey/us-central1/api`


## Swagger

Swagger is part of the Vue frontend application stack.

However, `./openapi.json` must be generated by running NestJS locally and downloading the file.

1. Start NestJS `npm run restapi`
2. `curl http://localhost:30010/api/api-json | jq . > openapi.json`
3. Be sure to commit the change to `./openapi.json`


## Auth Clients

An auth client is a set of client credentials, following the OAuth2 Client Credentials Grant type.

### Secret hashing

Auth clients have a secret stored in their firestore document.
This secret is hashed with [argon2](https://github.com/ranisalt/node-argon2-cli).

Firstly generate a 32-character-length secret using a secure password generation tool (e.g. `pwgen`)
```
api$ pwgen -s 32 1
1doOJWjJmXAe49q8GJV4x8uWpRwO78jn
```

Now hash the new secret for storing in firestore:
```
api$ echo -n "1doOJWjJmXAe49q8GJV4x8uWpRwO78jn" | npx argon2-cli -id -e
$argon2id$v=19$m=4096,t=3,p=1$jEo1JpEWrVam5bkIAOoqUg$y+sA0k9D4EvoN+uihHGEjQCS3ShLeKNu8gTxvEzDs80
```

The entire output string (including `$argon2id$v=19m`, etc) is stored as the value of the `secret` field.

The NestJS server will use the `node-argon2` library to verify the password during authentication.

### Creating a new auth client

1. Create a new secret hash using the above instructions. Keep note of the secret before it was hashed (e.g. `1doOJWjJmXAe49q8GJV4x8uWpRwO78jn`). This is the `client_secret`
2. In the firestore UI, create a new document in the `/authClients` collection, using the UI-generated auto-id. This is the `client_id`
* `secret` - the hashed secret. e.g. `$argon2id$v=19$m=4096,t=3,p=1$jEo1JpEWrVam5bkIAOoqUg$y+sA0k9D4EvoN+uihHGEjQCS3ShLeKNu8gTxvEzDs80`
* `organizationId` - the oganization ID. e.g. `GYByxtyzprqEuwWzekiK`
* `created` - the current timestamp (use the firestore UI).

You should be able to use the `client_id` and `client_secret` values as parameters to the `https://app.odyssey.stream/api/v1/auth/token` endpoint, returning a bearer token.

## JWKs (for JWT signing)

**Warning: Repeating the below process on any environment will replace the existing keys, invalidating existing JWT tokens.**

### Generating signer & verifier keys

Keys are asymetric RSA 2048-bit private/public keys.

#### Private key

```
# Generate RSA private key
openssl genrsa -out ./private.key 2048
# Base64 encode to store as firebase function config string
cat private.key | base64 -w 0 > ./private.key.base64
```
This key can now be stored in the `restapi.jwtprivatekeypembase64` functions config


#### Public key

```
# Retrieve public key from private key
openssl rsa -in private.key -pubout -outform PEM -out public.key
# Base64 encode to store as firebase function config string
cat public.key | base64 -w 0 > ./public.key.base64
```
This key can now be stored in the `restapi.jwtpublickeypembase64` functions config


### Production Keys

Production keys are also stored in LastPass or similar. Ask Bram or Max if you need them for some reason.
